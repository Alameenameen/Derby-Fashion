<%-include("../../view/partials/user/header")%> 

<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <a class="breadcrumb-item text-dark" href="#">Home</a>
                <a class="breadcrumb-item text-dark" href="#">Shop</a>
                <span class="breadcrumb-item active">Shop List</span>
            </nav>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->

<!-- Search Results (if any) -->
<% if (locals.searchQuery) { %>
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <div class="bg-light p-3 mb-3">
                    <% if (searchResultsInfo) { %>
                        <h5><%= searchResultsInfo.message %></h5>
                        <a href="/shop" class="btn btn-sm btn-outline-primary">Clear Search</a>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
<% } %>

<!-- Shop Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <!-- Left Sidebar -->
        <div class="col-lg-3 col-md-4">
            <!-- Categories Section -->
            <div class="mb-4">
                <h5 class="section-title position-relative text-uppercase mb-3">
                    <span class="bg-secondary pr-3">Categories</span>
                </h5>
                <div class="bg-light p-4">
                    <% categories.forEach(category => { %>
                        <a href="/shop?category=<%= category._id %>"
                           class="d-block text-dark mb-2 <%= categoryId === category._id.toString() ? 'font-weight-bold' : '' %>">
                            <%= category.name %>
                        </a>
                    <% }) %>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="mb-4">
                <h5 class="section-title position-relative text-uppercase mb-3">
                    <span class="bg-secondary pr-3">Filter by</span>
                </h5>
                <div class="bg-light p-4">
                    <form id="filterForm">
                        <!-- Filter Options -->
                        <div class="mb-3">
                            <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="filter-new">
                                <label class="custom-control-label" for="filter-new">New Arrivals</label>
                            </div>
                            <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="filter-popular">
                                <label class="custom-control-label" for="filter-popular">Popular Items</label>
                            </div>
                            <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="filter-featured">
                                <label class="custom-control-label" for="filter-featured">Featured Items</label>
                            </div>
                        </div>

                        <!-- Price Section -->
                        <div class="mb-3">
                            <h6 class="text-uppercase mb-3">Price</h6>
                            <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="price-low-high">
                                <label class="custom-control-label" for="price-low-high">Low to High</label>
                            </div>
                            <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="price-high-low">
                                <label class="custom-control-label" for="price-high-low">High to Low</label>
                            </div>
                        </div>

                        <!-- Name Section -->
                        <div class="mb-3">
                            <h6 class="text-uppercase mb-3">Name</h6>
                            <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="name-asc">
                                <label class="custom-control-label" for="name-asc">A to Z</label>
                            </div>
                            <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="name-desc">
                                <label class="custom-control-label" for="name-desc">Z to A</label>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary btn-block" id="applyFilter">Apply Filter</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-9 col-md-8">
            <!-- Sort Options -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="btn-group">
                    <button class="btn btn-sm btn-light"><i class="fa fa-th-large"></i></button>
                    <button class="btn btn-sm btn-light ml-2"><i class="fa fa-bars"></i></button>
                </div>
                <div class="dropdown ml-2">
                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-toggle="dropdown">
                        Sorting
                    </button>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="#">Latest</a>
                        <a class="dropdown-item" href="#">Price Low to High</a>
                        <a class="dropdown-item" href="#">Price High to Low</a>
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            <!-- <div class="row">
                <% products.forEach(product => { %>
                    <% if (!product.isBlocked) { %> 
                    <div class="col-lg-4 col-md-6 col-sm-12 pb-1">
                        <div class="product-item bg-light mb-4">
                            <div class="product-img position-relative overflow-hidden">
                                <a href="/productDetails?id=<%= product._id %>">
                                    <img class="img-fluid w-100" src="/uploads/<%= product.productImage[0] %>" alt="<%= product.productName %>">
                                </a>
                            </div>
                            <div class="text-center py-4">
                                <a class="h6 text-decoration-none text-truncate" href="/productDetails?id=<%= product._id %>">
                                    <%= product.productName %>
                                </a>
                                <div class="d-flex align-items-center justify-content-center mt-2">
                                    <h5>₹<%= product.salePrice %></h5>
                                    <h6 class="text-muted ml-2"><del>₹<%= product.regularPrice %></del></h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>
                <% }) %>
            </div> -->


            <!-- <div class="row">
                <% products.forEach(product => { %>
                    <% if (!product.isBlocked) { %> 
                    <div class="col-lg-4 col-md-6 col-sm-12 pb-1">
                        <div class="product-item bg-light mb-4">
                            <div class="product-img position-relative overflow-hidden">
                                <a href="/productDetails?id=<%= product._id %>">
                                    <img class="img-fluid w-100" src="/uploads/<%= product.productImage[0] %>" alt="<%= product.productName %>">
                                </a>
                            </div>
                            <div class="text-center py-4">
                                <a class="h6 text-decoration-none text-truncate" href="/productDetails?id=<%= product._id %>">
                                    <%= product.productName %>
                                </a>
                                <%
    // Fetch product-level offer
    let productOffer = product.offer && product.offer.isActive ? product.offer.percentage : 0;

    // Fetch category-level offer (fixing potential undefined issue)
    let categoryOffer = (product.category && product.category.categoryOffer && product.category.categoryOffer.isActive) 
                        ? product.category.categoryOffer.percentage 
                        : 0;

    // Compare the two offers and select the highest one
    let displayOffer = Math.max(productOffer, categoryOffer);
    let hasOffer = displayOffer > 0;
%>

<% if (hasOffer) { %>
    <div class="offer-badge position-absolute bg-danger text-white px-2 py-1" style="top: 10px; left: 10px;">
        <%= displayOffer %>% OFF
    </div>
<% } %>

<div class="d-flex align-items-center justify-content-center mt-2">
    <% if (hasOffer) { %>
        <h5>₹<%= product.salePrice%></h5>
        <h6 class="text-muted ml-2"><del>₹<%= product.regularPrice %></del></h6>
    <% } else { %>
        <h5>₹<%= product.salePrice %></h5>
    <% } %>
</div>

                                
                            </div>
                        </div>
                    </div>
                    <% } %>
                <% }) %>
            </div> -->
            

   
            <div class="row">
                <% for(let i = 0; i < products.length; i++) { 
                    let productOffer = products[i].offer && products[i].offer.isActive ? products[i].offer.percentage : 0;
                    
                    let categoryOffer = products[i].category && products[i].category.categoryOffer && 
                                      products[i].category.categoryOffer.isActive ? 
                                      products[i].category.categoryOffer.percentage : 0;
                    
                    let displayOffer = 0;
                    if (productOffer > 0 && categoryOffer > 0) {
                        displayOffer = Math.max(productOffer, categoryOffer);
                    } else if (productOffer > 0) {
                        displayOffer = productOffer;
                    } else if (categoryOffer > 0) {
                        displayOffer = categoryOffer;
                    }
                    
                    let hasOffer = displayOffer > 0;
                %>
                    <div class="col-lg-4 col-md-6 col-sm-12 pb-1">
                        <div class="product-item bg-light mb-4">
                            <div class="product-img position-relative overflow-hidden">
                                <a href="/productDetails?id=<%= products[i]._id %>">
                                    <img class="img-fluid w-100" src="/uploads/<%= products[i].productImage[0] %>" alt="<%= products[i].productName %>">
                                </a>

                                <div class="product-action">
                                    <!-- <a class="btn btn-outline-dark btn-square" href=""><i class="fa fa-shopping-cart"></i></a> -->
                                    <a class="btn btn-outline-dark btn-square" onclick="addToWishlist('<%=products[i]._id%>')">
                                        <i class="far fa-heart"></i>
                                    </a>
                                    <!-- <a class="btn btn-outline-dark btn-square" href=""><i class="fa fa-sync-alt"></i></a>
                                    <a class="btn btn-outline-dark btn-square" href=""><i class="fa fa-search"></i></a> -->
                                </div>
                                <% if (hasOffer) { %>
                                    <div class="offer-badge position-absolute bg-danger text-white px-2 py-1" style="top: 10px; left: 10px;">
                                        <%= displayOffer %>% OFF
                                    </div>
                                <% } %>
                            </div>
                            <div class="text-center py-4">
                                <a class="h6 text-decoration-none text-truncate" href="/productDetails?id=<%= products[i]._id %>">
                                    <%= products[i].productName %>
                                </a>
                                <div class="d-flex align-items-center justify-content-center mt-2">
                                    <% if (hasOffer) { %>
                                        <h5>₹<%= products[i].salePrice %></h5>
                                        <h6 class="text-muted ml-2"><del>₹<%= products[i].regularPrice %></del></h6>
                                    <% } else { %>
                                        <h5>₹<%= products[i].salePrice %></h5>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>


            <!-- Pagination -->
            <% if (totalPages > 1) { %>
                <div class="d-flex justify-content-center mt-4">
                    <nav>
                        <ul class="pagination">
                            <% for(let i = 1; i <= totalPages; i++) { %>
                                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                    <a class="page-link" href="/shop?page=<%= i %><%= categoryId ? '&category=' + categoryId : '' %>">
                                        <%= i %>
                                    </a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                </div>
            <% } %>
        </div>
    </div>
</div>
<!-- Shop End -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const applyFilterBtn = document.getElementById('applyFilter');
    const checkboxes = filterForm.querySelectorAll('input[type="checkbox"]');

    // Ensure only one checkbox can be checked at a time
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                checkboxes.forEach(cb => {
                    if (cb !== this) cb.checked = false;
                });
            }
        });
    });

    // Apply filter when button is clicked
    applyFilterBtn.addEventListener('click', function() {
        const checkedBox = Array.from(checkboxes).find(cb => cb.checked);
        if (!checkedBox) return;

        // Map checkbox IDs to sort values
        const sortMap = {
            'filter-new': 'new-arrivals',
            'filter-popular': 'popularity',
            'filter-featured': 'featured',
            'price-low-high': 'price-low-high',
            'price-high-low': 'price-high-low',
            'filter-rating': 'rating',
            'name-asc': 'name-asc',
            'name-desc': 'name-desc'
        };

        const sortValue = sortMap[checkedBox.id];
        const params = new URLSearchParams(window.location.search);
        
        // Update sort parameter
        params.set('sort', sortValue);
        
        // Maintain category if it exists
        const categoryId = params.get('category');
        if (categoryId) {
            params.set('category', categoryId);
        }
        
        // Reset to page 1 when filtering
        params.set('page', '1');

        // Redirect with new filter
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    });
});
</script>

<%-include("../../view/partials/user/footer")%> 
