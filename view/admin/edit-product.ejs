<%- include("../../view/partials/admin/header") %>
<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" rel="stylesheet">
</head>
<style>
    /* Main Layout */
    .content-main {
      padding: 2rem;
      background-color: #f8f9fa;
    }
  
    .product-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 2rem;
    }
  
    /* Form Elements */
    .form-label {
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 0.75rem;
      display: block;
    }
  
    .form-control,
    .form-select {
      width: 100%;
      padding: 0.875rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
    }
  
    .form-control:focus,
    .form-select:focus {
      border-color: #2c2c2c;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
      outline: none;
    }
  
    /* Section Headers */
    .section-title {
      color: #1a1a1a;
      font-size: 1.25rem;
      font-weight: 600;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e0e0e0;
    }
  
    /* Image Preview */
    .image-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
  
    .preview-card {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }
  
    .preview-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
  
    /* Delete Button */
    .delete-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: #2c2c2c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
  
    .delete-btn:hover {
      background-color: #1a1a1a;
    }
  
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
  
    .btn-primary {
      background-color: #2c2c2c;
      color: white;
      border: none;
    }
  
    .btn-primary:hover {
      background-color: #1a1a1a;
      transform: translateY(-1px);
    }
  
    .btn-danger {
      background-color: #1a1a1a;
      color: white;
      border: none;
    }
  
    .btn-danger:hover {
      background-color: #000000;
      transform: translateY(-1px);
    }
  
    /* Error Messages */
    .error-message {
      color: #dc2626;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
  
    /* Price Inputs Container */
    .price-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }
  
    /* File Upload */
    .file-upload {
      border: 2px dashed #e0e0e0;
      padding: 2rem;
      text-align: center;
      border-radius: 8px;
      margin: 1rem 0;
    }
  
    .file-upload:hover {
      border-color: #2c2c2c;
    }
  
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .content-main {
        padding: 1rem;
      }
      
      .product-card {
        padding: 1rem;
      }
    }
  </style>

<section class="content-main">
    <div class="row">
        <div class="col-9">
            <div class="content-header">
                <h2 class="content-title">Edit Product</h2>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-body">
                    <form method="post" action="/admin/editProduct/<%= product._id %>" enctype="multipart/form-data" onsubmit="return validateEditForm()">
                        <div class="mb-4">
                            <label for="product_name" class="form-label">Product Name</label>
                            <input type="text" name="productName" value="<%= product.productName %>" class="form-control border" id="product_name" required>
                            <div id="productName-error" class="error-message"></div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Full Description</label>
                            <textarea name="description" class="form-control border" rows="4" required><%= product.description ? product.description.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '' %></textarea>
                            <div id="description-error" class="error-message"></div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Brand</label>
                            <select class="form-select border" name="brand" required>
                                <option value="">Select Brand</option>
                                <% brands.forEach(brand => { %>
                                    <% if (!brand.isBlocked) { %>
                                        <option value="<%= brand._id %>"  <%= (product.brand && product.brand._id && product.brand._id.toString() === brand._id.toString()) ? 'selected' : '' %>>
                                            <%= brand.brandName %></option>
                                    <% } %>
                                <% }); %>
                            </select>
                            <div id="brand-error" class="error-message"></div>
                        </div>

                        <div class="row">
                            <div class="col-lg-4 mb-4">
                                <label class="form-label">Regular Price</label>
                                <input placeholder="₹" name="regularPrice" type="number" value="<%= product.regularPrice %>" class="form-control border" required>
                                <div id="regularPrice-error" class="error-message"></div>
                            </div>
                            <!-- <div class="col-lg-4 mb-4">
                                <label class="form-label">Sale Price</label>
                                <input placeholder="₹" name="salePrice" type="number" value="<%= product.salePrice %>" class="form-control border">
                                <div id="salePrice-error" class="error-message"></div>
                            </div> -->
                        </div>

                        <!-- <div class="col-lg-4 mb-4">
                            <label class="form-label">Color</label>
                            <input name="color" type="text" value="<%= product.color %>" class="form-control border">
                            <div id="color-error" class="error-message"></div>
                        </div> -->

                        <div class="mb-4">
                            <label class="form-label">Category</label>
                            <select class="form-select border" name="category" id="categorySelect" required onchange="updateSizes()">
                                <% cat.forEach(c => { %>
                                    <option value="<%= c.name %>" data-type="<%= c.type %>" <%= product.category.equals(c._id) ? 'selected' : '' %>><%= c.name %></option>
                                <% }); %>
                            </select>
                            <div id="category-error" class="error-message"></div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Sizes and Quantities</label>
                            <div id="sizesContainer">
                                <!-- Size inputs will be dynamically added here -->
                            </div>
                            <div id="size-error" class="error-message"></div>
                        </div>

                        <div class="card mb-2">
                            <div class="card-header">
                                <h4>Current Product Images</h4>
                            </div>
                            <div class="row">
                                <% product.productImage.forEach((image, index) => { %>
                                    <div class="col-md-3 mb-3" data-image="<%= image %>">
                                        <div class="position-relative">
                                            <img src="/uploads/<%= image %>" class="img-fluid" alt="Product Image">
                                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" 
                                                    onclick="deleteImage('<%= image %>', '<%= product._id %>')">×</button>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        </div>

                        <div class="card mb-2">
                            <div class="card-header">
                                <h4>Add New Images</h4>
                            </div>
                            <div class="row">
                                <div class="card-body align-items-center mb-3">
                                    <label class="form-label">Product Images</label>
                                    <input class="form-control" type="file" name="images" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
                                    <div id="images-preview-section">
                                        <!-- This will contain all image containers -->
                                    </div>
                                    <div class="error-message" id="images-error" style="color: red; display: none;"></div>

                                    <button type="button" class="btn btn-primary mt-3" onclick="addMoreImages()">Add More Images</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <button class="btn btn-md rounded font-sm hover-up" type="submit">Update Product</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>

<script>
const croppies = {};
let currentImageCount = 0;
const MAX_IMAGES = 4;




function initializeSizes(existingSizes) {
    // Wait for categorySelect to be available
    const categorySelect = document.getElementById('categorySelect');
    if (!categorySelect) return;

    // Trigger updateSizes to create the size inputs
    updateSizes();

    // Now set the values from existingSizes
    if (existingSizes && existingSizes.length > 0) {
        existingSizes.forEach(sizeData => {
            const input = document.querySelector(`.size-quantity[data-size="${sizeData.size}"]`);
            if (input) {
                input.value = sizeData.quantity;
            }
        });
    }

    // Update the hidden input with the current sizes
    updateSizesArray();
}

// Make sure this runs after DOM is loaded

// Load existing sizes on page load
document.addEventListener('DOMContentLoaded', function() {
    const existingSizes = <%- JSON.stringify(product.sizes) %>;
    initializeSizes(existingSizes);
    updateSizes(); // This will set up the size inputs based on the category
});

function handleImageSelect(event) {
    const file = event.target.files[0];
    if (file) {
        const totalImages = currentImageCount + document.querySelectorAll('.current-image').length;
        if (totalImages >= MAX_IMAGES) {
            alert(`Maximum ${MAX_IMAGES} images allowed`);
            return;
        }
        
        currentImageCount++;
        const index = currentImageCount;
        
        const imageContainer = createImageContainer(index);
        document.getElementById('images-preview-section').appendChild(imageContainer);
        
        const reader = new FileReader();
        reader.onload = function(e) {
            viewImage(e, index);
        };
        reader.readAsDataURL(file);
        
        event.target.value = '';
    }
}

function createImageContainer(index) {
    const container = document.createElement('div');
    container.className = 'mb-4';
    container.id = `image-section-${index}`;
    
    container.innerHTML = `
        <div id="crop-container${index}" class="crop-container" style="display: none;">
            <div id="croppie${index}" class="croppie-wrapper"></div>
            <button type="button" class="btn btn-sm btn-primary mt-3" onclick="saveImage('${index}')">Save</button>
        </div>
        <div id="image-preview${index}"></div>
    `;
    
    return container;
}

function viewImage(event, index) {
    const imageData = event.target.result;
    const cropContainer = document.getElementById(`crop-container${index}`);
    const croppieElement = document.getElementById(`croppie${index}`);

    if (croppies[index]) {
        croppies[index].destroy();
    }

    cropContainer.style.display = 'block';

    croppies[index] = new Croppie(croppieElement, {
        viewport: { width: 150, height: 150, type: 'square' },
        boundary: { width: 250, height: 250 },
        showZoomer: true,
        enableOrientation: true,
    });

    croppies[index].bind({
        url: imageData,
    });
}

function saveImage(index) {
    if (croppies[index]) {
        croppies[index]
            .result({
                type: 'base64',
                format: 'png',
            })
            .then((base64) => {
                const timestamp = Date.now();
                const renamedFile = `cropped-img-${timestamp}-${index}.png`;

                const hiddenInputId = `croppedImage${index}`;
                let hiddenInput = document.getElementById(hiddenInputId);

                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'croppedImages[]';
                    hiddenInput.id = hiddenInputId;
                    document.querySelector('form').appendChild(hiddenInput);
                }

                hiddenInput.value = base64;

                const previewContainer = document.getElementById(`image-preview${index}`);
                previewContainer.innerHTML = '';
                
                const previewWrapper = document.createElement('div');
                previewWrapper.className = 'd-flex align-items-center gap-2 mt-3';
                
                const img = document.createElement('img');
                img.src = base64;
                img.alt = renamedFile;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'btn btn-sm btn-danger';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = () => deleteImage(index);
                
                previewWrapper.appendChild(img);
                previewWrapper.appendChild(deleteBtn);
                previewContainer.appendChild(previewWrapper);

                document.getElementById(`crop-container${index}`).style.display = 'none';
                croppies[index].destroy();
                croppies[index] = null;
            });
    }
}

function deleteImage(imageName) {
    fetch('/admin/deleteImage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            imageNameToServer: imageName,
            productIdToServer: '<%= product._id %>'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status) {
            document.querySelector(`[data-image="${imageName}"]`).remove();
        }
    });
}


function addMoreImages() {
    const totalImages = currentImageCount + document.querySelectorAll('.current-image').length;
    if (totalImages >= MAX_IMAGES) {
        alert(`Maximum ${MAX_IMAGES} images allowed`);
        return;
    }
    document.getElementById('imageInput').click();
}

function updateSizes() {
    const categorySelect = document.getElementById('categorySelect');
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    const categoryType = selectedOption.getAttribute('data-type');
    const sizesContainer = document.getElementById('sizesContainer');
    sizesContainer.innerHTML = '';

    let sizes = [];
    if (categoryType === 'Clothing') {
        sizes = ['S', 'M', 'L', 'XL', 'XXL'];
    } else if (categoryType === 'Footwear') {
        sizes = ['5', '6', '7', '8', '9', '10'];
    }

    let sizesArrayInput = document.getElementById('sizesArrayInput');
    if (!sizesArrayInput) {
        sizesArrayInput = document.createElement('input');
        sizesArrayInput.type = 'hidden';
        sizesArrayInput.id = 'sizesArrayInput';
        sizesArrayInput.name = 'sizes';
        document.querySelector('form').appendChild(sizesArrayInput);
    }

    // Get existing quantities from the product data
    const existingSizes = <%- JSON.stringify(product.sizes) %>;
    
    sizes.forEach(size => {
        const existingSize = existingSizes.find(s => s.size === size);
        const quantity = existingSize ? existingSize.quantity : 0;
        
        const sizeDiv = document.createElement('div');
        sizeDiv.className = 'row mb-2';
        sizeDiv.innerHTML = `
            <div class="col-md-2">
                <label class="form-label">Size ${size}</label>
            </div>
            <div class="col-md-4">
                <input type="number" 
                       class="form-control border size-quantity" 
                       data-size="${size}"
                       placeholder="Quantity for size ${size}" 
                       min="0" 
                       value="${quantity}"
                       onchange="updateSizesArray()">
            </div>
        `;
        sizesContainer.appendChild(sizeDiv);
    });

    // updateSizesArray();
}

function updateSizesArray() {
    const sizeInputs = document.querySelectorAll('.size-quantity');
    const sizesArray = [];

    sizeInputs.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        const size = input.getAttribute('data-size');
        
        if (quantity > 0) {
            sizesArray.push({
                size: size,
                quantity: quantity
            });
        }
    });

    const sizesArrayInput = document.getElementById('sizesArrayInput');
    sizesArrayInput.value = JSON.stringify(sizesArray);
}





function validateEditForm() {
    clearErrorMessages();
    let isValid = true;

    // Get form elements
    const name = document.getElementsByName('productName')[0]?.value || '';
    // const description = document.getElementsByName('description')[0]?.value || '';
    const brand = document.getElementsByName('brand')[0]?.value || '';
    const price = document.getElementsByName('regularPrice')[0]?.value || '';
    const saleprice = document.getElementsByName('salePrice')[0]?.value || '';
    const category = document.getElementsByName('category')[0]?.value || '';
    const status = document.getElementsByName('status')[0]?.value;
    // const croppedImageInputs = document.querySelectorAll('input[name="croppedImages"]');
    const getActualLength = (str) => str.replace(/\s/g, '').length;


    const descriptionElement = document.querySelector('textarea[name="description"]');
    const description = descriptionElement ? descriptionElement.value : '';

    // Validate product name
    if (name.trim() === "") {
        displayErrorMessage('productName-error', 'Please enter a product name.');
        isValid = false;
    } else if (!/^[a-zA-Z0-9\s-]+$/.test(name.trim())) {
        displayErrorMessage('productName-error', 'Product name can only contain letters, numbers, spaces, and hyphens.');
        isValid = false;
    } else if (getActualLength(name) < 3) {
        displayErrorMessage('productName-error', 'Product name must contain at least 3 letters/numbers (spaces not counted).');
        isValid = false;
    }

    // Validate description
    if (!description || description.trim() === "") {
        displayErrorMessage('description-error', 'Please enter a product description.');
        isValid = false;
    } else if (getActualLength(description) < 10) {
        displayErrorMessage('description-error', 'Description must contain at least 10 letters (spaces not counted).');
        isValid = false;
    }

    // Validate brand
    if (brand.trim() === "") {
        displayErrorMessage('brand-error', 'Please enter a brand name.');
        isValid = false;
    }

    // Validate regular price
    if (!price || !/^\d+(\.\d{1,2})?$/.test(price) || parseFloat(price) <= 0) {
        displayErrorMessage('regularPrice-error', 'Please enter a valid positive price.');
        isValid = false;
    }

    // Validate sale price
    if (saleprice !== '') {
        if (!/^\d+(\.\d{1,2})?$/.test(saleprice) || parseFloat(saleprice) <= 0) {
            displayErrorMessage('salePrice-error', 'Please enter a valid positive sale price.');
            isValid = false;
        } else if (parseFloat(saleprice) >= parseFloat(price)) {
            displayErrorMessage('salePrice-error', 'Sale price must be less than regular price.');
            isValid = false;
        }
    }

    // Validate category
    if (!category || category.trim() === "") {
        displayErrorMessage('category-error', 'Please select a category.');
        isValid = false;
    }

    // Validate status
    if (status !== undefined) {
        const validStatuses = ['inStock', 'outOfStock', 'Discontinued', 'Available'];
        if (status.trim() === "") {
            displayErrorMessage('status-error', 'Please select a status.');
            isValid = false;
        } else if (!validStatuses.includes(status)) {
            displayErrorMessage('status-error', 'Invalid status value selected.');
            isValid = false;
        }
    }

    // Validate images (Optional: Allow no images for edit if existing ones are retained)
    // if (croppedImageInputs.length === 0) {
    //     displayErrorMessage('images-error', 'Please upload at least one image for the product.');
    //     isValid = false;
    // }

    // Validate sizes
    const sizeInputs = document.querySelectorAll('.size-quantity');
    let totalQuantity = 0;

    sizeInputs.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        if (quantity < 0) {
            displayErrorMessage('size-error', 'Quantities cannot be negative.');
            isValid = false;
        }
        totalQuantity += quantity;
    });

    if (totalQuantity === 0) {
        displayErrorMessage('size-error', 'At least one size must have a quantity greater than 0.');
        isValid = false;
    }

    // Update sizes array before submission if form is valid
    if (isValid) {
        updateSizesArray();
    }

    return isValid;
}
function clearErrorMessages() {
    document.querySelectorAll('.error-message').forEach(el => (el.textContent = ''));
}

// Function to display an error message
function displayErrorMessage(id, message) {
    const errorElement = document.getElementById(id);
    if (errorElement) {
        errorElement.textContent = message;
    }
}


       </script>
<%- include("../../view/partials/admin/footer") %>
       