<%- include("../../view/partials/admin/header") %>

<style>
    :root {
        --dark-blue: #1a237e;
        --light-blue: #303f9f;
        --white: #ffffff;
        --black: #000000;
        --gray: #f5f5f5;
    }

    .container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .success-message {
        background-color: #4CAF50;
        color: white;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
    }

    .card {
        background: var(--white);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background: var(--dark-blue);
        color: var(--white);
        padding: 20px;
        border-radius: 8px 8px 0 0;
    }

    .card-title {
        margin: 0;
        font-size: 24px;
    }

    .table-container {
        overflow-x: auto;
        padding: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th {
        background: var(--dark-blue);
        color: var(--white);
        padding: 12px;
        text-align: left;
    }

    td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
    }

    tr:hover {
        background-color: var(--gray);
    }

    .status-select {
        padding: 8px;
        border: 1px solid var(--dark-blue);
        border-radius: 4px;
        margin-right: 10px;
    }

    .save-btn, .view-address-btn, .view-details-btn {
        background: var(--dark-blue);
        color: var(--white);
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .save-btn:hover, .view-address-btn:hover, .view-details-btn:hover {
        background: var(--light-blue);
    }

    .save-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-content {
        background: var(--white);
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
        position: relative;
    }

    .close-modal {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 24px;
        cursor: pointer;
    }

    .address-details {
        margin-top: 20px;
    }


    .filter-section {
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.filter-form {
    display: flex;
    gap: 20px;
    align-items: flex-end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: 500;
    color: #666;
}

.filter-group input,
.filter-group select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-width: 200px;
}

.filter-buttons {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.btn-primary {
    background: #0d6efd;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    text-decoration: none;
}
</style>
<div class="container">
    <div class="success-message" id="successMessage">
        Status updated successfully!
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="filter-section">
                <form action="/admin/orderList" method="GET" class="filter-form">
                    <div class="filter-group">
                        <label for="startDate">From Date:</label>
                        <input type="date" id="startDate" name="startDate" class="form-control" 
                            value="<%= locals.filters?.startDate || '' %>">
                    </div>
                    
                    <div class="filter-group">
                        <label for="endDate">To Date:</label>
                        <input type="date" id="endDate" name="endDate" class="form-control"
                            value="<%= locals.filters?.endDate || '' %>">
                    </div>
                    
                    <div class="filter-group">
                        <label for="status">Status:</label>
                        <select id="status" name="status" class="form-control">
                            <option value="">All Status</option>
                            <option value="pending" <%= locals.filters?.status === 'pending' ? 'selected' : '' %>>Pending</option>
                            <option value="processing" <%= locals.filters?.status === 'processing' ? 'selected' : '' %>>Processing</option>
                            <option value="shipped" <%= locals.filters?.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                            <option value="delivered" <%= locals.filters?.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                            <option value="cancelled" <%= locals.filters?.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                            <option value="Return Request" <%= locals.filters?.status === 'Return Request' ? 'selected' : '' %>>Return Request</option>
                            <option value="Returned" <%= locals.filters?.status === 'Returned' ? 'selected' : '' %>>Returned</option>
                        </select>
                    </div>
            
                    <div class="filter-buttons">
                        <button type="submit" class="btn btn-primary">Filter</button>
                        <a href="/admin/orderList" class="btn btn-secondary">Reset</a>
                    </div>
                </form>
            </div>
            <h1 class="card-title">Order lists</h1>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer Details</th>
                        <th>Shipping Address</th>
                        <th>Current Status</th>
                        <th>Update Status</th>
                        <th>Order Date</th>
                        <th>Order Details</th>
                    </tr>
                </thead>
                <tbody>
                    <% orders.forEach(order => { %>
                        <tr>
                            <td><%= order.orderId || order._id %></td>
                            <td>
                                <strong><%= order.user ? order.user.name : 'Guest' %></strong><br>
                                <%= order.user ? order.user.email : 'N/A' %>
                            </td>
                            <td>
                                <button class="view-address-btn" 
                                onclick="showAddressDetails('<%= JSON.stringify(order.address).replace(/'/g, '\\\\') %>')">
                            View Address
                        </button>
                        
                            </td>
                            <td><%= order.status %></td>
                            <td>
                                <select id="status-<%= order._id %>" class="status-select">
                                    <% if (order.status === 'delivered' || order.status === 'Return Request' || order.status === 'Returned') { %>
                                        <option value="Return Request" <%= order.status === 'Return Request' ? 'selected' : '' %>>Return Request</option>
                                        <option value="Returned" <%= order.status === 'Returned' ? 'selected' : '' %>>Returned</option>
                                    <% } else if (order.status === 'shipped') { %>
                                        <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                                        <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                                        <option value="Return Request" <%= order.status === 'Return Request' ? 'selected' : '' %>>Return Request</option>
                                        <option value="Returned" <%= order.status === 'Returned' ? 'selected' : '' %>>Returned</option>
                                    <% } else if (order.status === 'Returned') { %>
                                        <option value="Returned" <%= order.status === 'Returned' ? 'selected' : '' %>>Returned</option>
                                    <% } else { %>
                                        <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                                        <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Processing</option>
                                        <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                                        <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                                        <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                                    <% } %>
                                </select>
                                <button class="save-btn" onclick="updateStatus('<%= order._id %>')" 
                                    <%= order.status === 'cancelled' ? 'disabled' : '' %>>
                                    Update
                                </button>
                            
                                
                            </td>
                            <td><%= new Date(order.createdOn).toLocaleDateString() %></td>
                            <td>
                                <button class="view-details-btn" onclick="window.location.href='/admin/orderList/details/<%= order._id %>'">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div id="addressModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAddressModal()">&times;</span>
        <h2>Shipping Address Details</h2>
        <div id="modalAddressContent" class="address-details">
            <!-- Address details will be populated here -->
        </div>
    </div>
</div>



<script>
function showAddressDetails(addressData) {
    try {
        const address = JSON.parse(addressData);
        const modalContent = document.getElementById('modalAddressContent');
        modalContent.innerHTML = `
            <p><span class="address-label">Name:</span> ${address.name || 'N/A'}</p>
            <p><span class="address-label">Street:</span> ${address.street || 'N/A'}</p>
            <p><span class="address-label">City:</span> ${address.city || 'N/A'}</p>
            <p><span class="address-label">State:</span> ${address.state || 'N/A'}</p>
            <p><span class="address-label">ZIP Code:</span> ${address.zipCode || 'N/A'}</p>
            <p><span class="address-label">Phone:</span> ${address.phone || 'N/A'}</p>
        `;

        const modal = document.getElementById('addressModal');
        modal.style.display = 'flex';
    } catch (error) {
        console.error('Error displaying address:', error);
        alert('Failed to display address details');
    }
}



async function updateStatus(orderId) {
    const selectElement = document.getElementById(`status-${orderId}`);
    const newStatus = selectElement.value;
    
    try {
        const response = await fetch(`/admin/orderList/updateStatus/${orderId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';

            // Find and update the status cell
            const statusCell = selectElement.closest('tr').querySelector('td:nth-child(4)');
            statusCell.textContent = newStatus;
            
            // If status is delivered, Return Request, or Returned, modify select options
            if (newStatus === 'delivered' || newStatus === 'Return Request' ) {
                selectElement.innerHTML = `
                    <option value="Return Request" ${newStatus === 'Return Request' ? 'selected' : ''}>Return Request</option>
                    <option value="Returned" ${newStatus === 'Returned' ? 'selected' : ''}>Returned</option>
                `;
            } else if (newStatus === 'shipped') {
                selectElement.innerHTML = `
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="Return Request">Return Request</option>
                    <option value="Returned">Returned</option>
                `;
            } else if (newStatus === 'Returned') {
                selectElement.innerHTML = `
                    <option value="Returned">Returned</option>
                `;
            } else if (newStatus === 'cancelled') {
                selectElement.innerHTML = `
                    <option value="cancelled" selected>Cancelled</option>
                `;
            }
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 1000);
        } else {
            throw new Error(data.message || 'Failed to update status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update order status');
    }
}

// Add this function to handle initial page load status
document.addEventListener('DOMContentLoaded', () => {
    const selects = document.querySelectorAll('.status-select');
    selects.forEach(select => {
        const currentStatus = select.value;
        if (currentStatus === 'delivered' || currentStatus === 'Return Request' || currentStatus === 'Returned') {
            select.innerHTML = `
                <option value="Return Request" ${currentStatus === 'Return Request' ? 'selected' : ''}>Return Request</option>
                <option value="Returned" ${currentStatus === 'Returned' ? 'selected' : ''}>Returned</option>
            `;
        }
    });
});

function closeAddressModal() {
    const modal = document.getElementById('addressModal');
    modal.style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addressModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}
</script>

<%- include("../../view/partials/admin/footer") %>